# FSF-to-POSSUM Shell Script Converter

This program converts an FSF file (generated by the POSSUM GUI’s “write” function) into a shell script that runs a full set of FSL/POSSUM commands. The resulting shell script creates and configures a simulation directory containing a brain reference image, processes input files (such as the object, activation images, B0 inhomogeneity, motion, slice profile, etc.), builds a pulse sequence command, and finally runs the POSSUM simulation via the `possumX` executable.

## Overview

The program reads a configuration file (the FSF file) that contains key–value pairs in the following format:

```
set entries($w,KEY) "value"
```

It then calculates derived parameters (for example, new image dimensions and voxel sizes) and builds a series of shell commands that perform the following steps:

1. **Create the output directory** where simulation files will be saved.
2. **Process the input object (brain image)**:  
   - Extract image dimensions and voxel sizes.
   - Create a brain reference image using FSL's `fslcreatehd`.
   - Register the input object using FSL's `flirt`.
3. **Copy and process additional input files**:
   - **MRpar**: Copy MR parameter file.
   - **Slice Profile (slcprof)**: Copy the slice profile file.
   - **Motion file**: Copy the motion file.
   - **Activation files**:  
     - For the activation image (T2.nii.gz), register it to the brain reference.
     - Copy the activation timecourse file.
   - **B0 inhomogeneity**: Process the provided B0 inhomogeneity file (e.g., b0A_dA.nii.gz) using `flirt` and (if needed) scale it appropriately.
4. **Pulse Sequence Processing**:
   - For standard sequences (EPI or GE), a single command is built that creates a binary pulse sequence matrix.
   - For a custom pulse sequence, the program copies all companion pulse files (such as `pulse.info`, `pulse.readme`, `pulse.posx`, `pulse.posy`, `pulse.posz`, and `pulse.com`) into the simulation directory.
5. **Run POSSUM Simulation**:
   - The final command calls `possumX` with the appropriate simulation parameters.
6. **Save POSSUM Setup File**:
   - A POSSUM setup file (possum.fsf) is generated so that the simulation parameters can be reloaded into the POSSUM GUI if desired.

## Requirements

- **Python 3**  
  The script is written in Python 3 and uses only the standard library (no additional packages are required).

- **FSL and POSSUM binaries**  
  The script assumes that the FSL and POSSUM binaries (e.g., `fslcreatehd`, `flirt`, `fslmaths`, `possumX`, etc.) are available in the locations specified by the `FSLDIR` and `POSSUMDIR` parameters. By default, if `POSSUMDIR` is not set, it defaults to the value of `FSLDIR`.

- **FSF file**  
  A valid FSF file (generated by POSSUM) with the expected key–value pairs must be provided.

## Usage

Run the script from the command line as follows:

```bash
./fsf_to_possum.py \<input.fsf\> \<output_script.sh\>
```

For example:

```bash
./fsf_to_possum.py possum_setup.fsf run_possum.sh
```

Once generated, the output shell script (e.g., `run_possum.sh`) can be executed to run the entire simulation pipeline.

## Input Files and Their Processing

The program expects the following input files (as referenced via the FSF file parameters):

- **brain.nii.gz (Input Object):**  
  This is the main image (object) that will be used in the simulation. Its dimensions and voxel sizes are used to create a brain reference image via `fslcreatehd` and to register the object using `flirt`.

- **T2.nii.gz (Activation Image):**  
  A 3D image that provides the spatial modulation for activation. It is registered to the brain reference image to create the “T2” output.

- **T2timecourse (Activation Modulation File):**  
  A file containing timecourse data for activation. This file is copied into the simulation directory.

- **b0A_dA.nii.gz (B0 Inhomogeneity Basis Set):**  
  A 3D B0 inhomogeneity image used as a basis for simulation of field inhomogeneities. The program processes this file (using `flirt` and `fslroi`) so that it fits the brain reference.

- **Pulse Sequence Files:**  
  For the pulse sequence:
  - When using a standard pulse sequence (EPI or GE), a pulse command is built using parameters (TE, TR, TRslice, etc.) to create a binary pulse file.
  - For a custom pulse sequence, the program copies the following files:
    - `pulse` (the binary matrix),
    - `pulse.info` (parameters used by POSSUM programs),
    - `pulse.readme` (user-friendly information),
    - `pulse.posx`, `pulse.posy`, `pulse.posz` (coordinate systems for x, y, and z),
    - `pulse.com` (the command that was used to generate the pulse sequence).

- **Motion File:**  
  A file describing the simulated motion. It is copied into the simulation directory. If a custom motion file is provided (via the `userintmotfile` parameter), that file is used.

- **Slice Profile (slcprof):**  
  The slice profile file is copied into the simulation directory.

- **MRpar (MR Parameters):**  
  The MR parameter file is copied into the simulation directory.

- **POSSUM Setup File (possum.fsf):**  
  A file that describes the entire simulation setup. This file is generated by the program so that the setup can be reloaded into the POSSUM GUI using the “Load” command.

## Output Files

When the generated shell script runs, it will produce an output directory (default is `./simdir` or as specified in the FSF file) containing:

- **brainref:** A brain reference image created by `fslcreatehd`.
- **brain:** The registered input object.
- **MRpar, slcprof, motion, T2, T2timecourse:** Files copied or processed from the corresponding input files.
- **b0… files:** Processed B0 inhomogeneity files (if a B0 file was provided).
- **pulse (and pulse.* files):** The pulse sequence (either generated or copied).
- **noise:** A file with noise parameters (if noise is enabled) or no file (if disabled).
- **possum.fsf:** A POSSUM setup file that reflects the current configuration.
- **possum.log:** A log file that records the execution of various commands.
- **A possumX command is executed** that launches the simulation.

## Example Workflow

1. **Prepare your FSF file:**  
   Ensure that your FSF file (e.g., `possum_setup.fsf`) includes the necessary parameters, such as file paths for `obvol`, `act1`, `act2`, `b0f`, `slcprof`, `mrpar`, etc.

2. **Run the Converter:**  
   ```bash
   ./fsf_to_possum.py possum_setup.fsf run_possum.sh
   ```

3. **Execute the Generated Script:**  
   Make the script executable if needed:
   ```bash
   chmod +x run_possum.sh
   ```
   Then run it:
   ```bash
   ./run_possum.sh
   ```

4. **Review the Output:**  
   The simulation directory (default `./simdir`) will contain all processed files, including the log file (`possum.log`), and the simulation will be executed by `possumX`.

## Customization

You may modify the shell command templates within the Python script to adjust processing steps or file locations as needed. In particular, you can adjust the pulse sequence command parameters.

## Troubleshooting
- **File Not Found Errors:**  
  Ensure that all paths provided in your FSF file are valid. The script expects paths for the input object, MRpar, slice profile, motion, activation, B0, and (if applicable) custom pulse files.

- **Directory Permissions:**  
  Make sure you have write permissions in the output directory.

## License and Acknowledgments

This script is provided as an example conversion of the POSSUM GUI’s TCL code to Python. The original POSSUM code is copyrighted by  
Ivana Drobnjak and Mark Jenkinson, FMRIB Image Analysis Group, University of Oxford (2006-2007).